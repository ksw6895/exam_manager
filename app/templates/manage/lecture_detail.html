<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ lecture.order }}ê°•. {{ lecture.title }} - {{ block.name }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header-info h1 {
            font-size: 1.6rem;
        }

        .header-info .meta {
            color: #667eea;
            margin-top: 0.3rem;
            font-size: 0.9rem;
        }

        .header-info .professor {
            color: #aaa;
            font-size: 0.85rem;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin-left: 1rem;
        }

        .stats-row {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1.2rem 1.5rem;
            text-align: center;
        }

        .stat-box .num {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-box .label {
            color: #aaa;
            font-size: 0.85rem;
        }

        .questions-container {
            margin-top: 2rem;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .question-number {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }

        .question-meta {
            font-size: 0.8rem;
            color: #888;
        }

        .question-type {
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .question-type.short {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .question-type.multi {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }

        .question-content {
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 1rem;
            white-space: pre-wrap;
        }

        .question-content .markdown-image {
            display: block;
            max-width: 100%;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .question-image {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .choices-list {
            list-style: none;
            margin-bottom: 1rem;
        }

        .choice-item {
            padding: 0.8rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .choice-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .choice-item.correct {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.4);
        }

        .choice-item.correct::after {
            content: 'âœ“ ì •ë‹µ';
            margin-left: auto;
            color: #2ecc71;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .choice-number {
            font-weight: bold;
            color: #667eea;
            min-width: 25px;
        }

        /* ì •ë‹µ ìˆ¨ê¹€ ìƒíƒœ */
        .answer-hidden .choice-item.correct {
            background: rgba(0, 0, 0, 0.2);
            border: none;
        }

        .answer-hidden .choice-item.correct::after {
            display: none;
        }

        .answer-hidden .short-answer {
            display: none;
        }

        /* ì •ë‹µ í‘œì‹œ ë²„íŠ¼ */
        .toggle-answer-btn {
            padding: 0.3rem 0.7rem;
            border-radius: 6px;
            border: 1px solid rgba(102, 126, 234, 0.4);
            background: transparent;
            color: #667eea;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 0.5rem;
        }

        .toggle-answer-btn:hover {
            background: rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .toggle-answer-btn.showing {
            background: rgba(46, 204, 113, 0.15);
            border-color: rgba(46, 204, 113, 0.4);
            color: #2ecc71;
        }

        .short-answer {
            background: rgba(46, 204, 113, 0.1);
            border-radius: 8px;
            padding: 1rem;
            border-left: 3px solid #2ecc71;
        }

        .short-answer label {
            display: block;
            color: #2ecc71;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .short-answer .answer {
            color: #fff;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #aaa;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .btn {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .toolbar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .toolbar button {
            font-size: 0.9rem;
        }

        /* í‚¤ì›Œë“œ ê´€ë¦¬ ì„¹ì…˜ */
        .keyword-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px dashed rgba(102, 126, 234, 0.3);
        }

        .keyword-section h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .current-keywords {
            margin-bottom: 1rem;
        }

        .keyword-badge {
            display: inline-block;
            background: rgba(102, 126, 234, 0.2);
            color: #ccc;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            font-size: 0.85rem;
            margin-right: 0.4rem;
            margin-bottom: 0.4rem;
        }

        .pdf-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .pdf-upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .pdf-upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .pdf-upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .upload-text {
            color: #aaa;
            font-size: 0.9rem;
        }

        .extraction-result {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 10px;
            border-left: 3px solid #2ecc71;
        }

        .extraction-result.error {
            background: rgba(231, 76, 60, 0.1);
            border-left-color: #e74c3c;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .note-delete-btn {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.4);
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .note-delete-btn:hover {
            background: rgba(231, 76, 60, 0.3);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-info">
                <h1>{{ lecture.order }}ê°•. {{ lecture.title }}</h1>
                <div class="meta">{{ block.name }}</div>
                {% if lecture.professor %}
                <div class="professor">ğŸ‘¤ {{ lecture.professor }}</div>
                {% endif %}
            </div>
            <div class="nav-links">
                <a href="{{ url_for('manage.list_lectures', block_id=block.id) }}">â† ê°•ì˜ ëª©ë¡</a>
                <a href="{{ url_for('manage.edit_lecture', lecture_id=lecture.id) }}">âœï¸ ìˆ˜ì •</a>
            </div>
        </header>

        <div class="stats-row">
            <div class="stat-box">
                <div class="num">{{ questions|length }}</div>
                <div class="label">ë¬¸ì œ ìˆ˜</div>
            </div>
            <div class="stat-box">
                <div class="num">{{ questions|selectattr('q_type', 'equalto', 'multiple_choice')|list|length }}</div>
                <div class="label">ê°ê´€ì‹</div>
            </div>
            <div class="stat-box">
                <div class="num">{{ questions|selectattr('q_type', 'equalto', 'multiple_response')|list|length }}</div>
                <div class="label">ë³µìˆ˜ì •ë‹µ</div>
            </div>
            <div class="stat-box">
                <div class="num">{{ questions|selectattr('q_type', 'equalto', 'short_answer')|list|length }}</div>
                <div class="label">ì£¼ê´€ì‹</div>
            </div>
        </div>

        <!-- í‚¤ì›Œë“œ ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="keyword-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">ğŸ”‘ ê°•ì˜ í‚¤ì›Œë“œ</h3>
                <button class="btn btn-secondary" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;"
                    onclick="toggleKeywordEdit()">
                    âœï¸ í¸ì§‘
                </button>
            </div>

            <!-- í‚¤ì›Œë“œ í‘œì‹œ ëª¨ë“œ -->
            <div class="current-keywords" id="currentKeywords">
                {% if lecture.keywords %}
                {% for keyword in lecture.keywords.split(',') %}
                <span class="keyword-badge">{{ keyword.strip() }}</span>
                {% endfor %}
                {% else %}
                <span style="color: #666;">ë“±ë¡ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</span>
                {% endif %}
            </div>

            <!-- í‚¤ì›Œë“œ í¸ì§‘ ëª¨ë“œ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
            <div id="keywordEditArea" style="display: none; margin-top: 1rem;">
                <textarea id="keywordEditInput" rows="3" placeholder="ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: í™œë™ì „ìœ„, Na+ Channel, íƒˆë¶„ê·¹"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; resize: vertical; font-size: 0.9rem;">{{ lecture.keywords or '' }}</textarea>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button class="btn btn-primary" style="padding: 0.4rem 1rem; font-size: 0.85rem;"
                        onclick="saveEditedKeywords()">ì €ì¥</button>
                    <button class="btn btn-secondary" style="padding: 0.4rem 1rem; font-size: 0.85rem;"
                        onclick="cancelKeywordEdit()">ì·¨ì†Œ</button>
                </div>
            </div>

        </div>

        <div class="keyword-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">ê°•ì˜ ë…¸íŠ¸ ì—…ë¡œë“œ (ì¸ë±ì‹±)</h3>
            </div>
            <div class="pdf-upload-area" id="noteUploadArea" onclick="document.getElementById('noteInput').click()">
                <div class="upload-icon">ğŸ“˜</div>
                <div class="upload-text">ê°•ì˜ ë…¸íŠ¸ PDFë¥¼ ì—…ë¡œë“œí•˜ë©´ í˜ì´ì§€ ë‹¨ìœ„ë¡œ ì¸ë±ì‹±ë©ë‹ˆë‹¤</div>
                <div class="upload-text" style="font-size: 0.8rem; color: #888; margin-top: 0.5rem;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”
                </div>
                <input type="file" id="noteInput" accept=".pdf" onchange="uploadLectureNote(this.files[0])">
            </div>
            <div id="noteUploadResult" style="display: none;"></div>
            <div id="noteStatusList" style="margin-top: 1rem;"></div>
        </div>

        <div class="toolbar" style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()"
                    style="width: 18px; height: 18px; cursor: pointer;">
                <label for="selectAll" style="margin-left: 0.5rem; cursor: pointer; user-select: none;">ì „ì²´ ì„ íƒ</label>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="showAllAnswers()">ğŸ“– ì „ì²´ ì •ë‹µ ë³´ê¸°</button>
                <button class="btn btn-secondary" onclick="hideAllAnswers()">ğŸ™ˆ ì „ì²´ ì •ë‹µ ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>

        <div class="questions-container">
            {% if questions %}
            {% for question in questions %}
            <div class="question-card answer-hidden" id="q-{{ question.id }}">
                <div class="question-header">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" class="q-checkbox" value="{{ question.id }}" onchange="updateActionBar()"
                            style="width: 18px; height: 18px; cursor: pointer; margin-right: 1rem;">
                        <div>
                            <span class="question-number">Q{{ question.question_number }}</span>
                            <span class="question-meta">({{ question.exam.title }})</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span
                            class="question-type {{ 'short' if question.q_type == 'short_answer' else 'multi' if question.q_type == 'multiple_response' else '' }}">
                            {% if question.q_type == 'short_answer' %}ì£¼ê´€ì‹
                            {% elif question.q_type == 'multiple_response' %}ë³µìˆ˜ì •ë‹µ
                            {% else %}ê°ê´€ì‹{% endif %}
                        </span>
                        <button class="toggle-answer-btn" onclick="toggleAnswer({{ question.id }}, this)">
                            ğŸ‘ï¸ ì •ë‹µ
                        </button>
                    </div>
                </div>

                {% if question.image_path %}
                <img src="{{ url_for('static', filename='uploads/' + question.image_path) }}" class="question-image"
                    alt="ë¬¸ì œ ì´ë¯¸ì§€">
                {% endif %}

                <div class="question-content">{{- (question.content or '(ì´ë¯¸ì§€ ë¬¸ì œ)') | md_image -}}</div>

                {% if question.q_type == 'short_answer' %}
                <div class="short-answer">
                    <label>ì •ë‹µ</label>
                    <div class="answer">{{ question.correct_answer_text or question.answer or 'ì •ë‹µ ì—†ìŒ' }}</div>
                </div>
                {% else %}
                <ul class="choices-list">
                    {% for choice in question.choices %}
                    <li class="choice-item {{ 'correct' if choice.is_correct else '' }}">
                        <span class="choice-number">{{ choice.choice_number }}.</span>
                        <span>{{ choice.content }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">
                <div class="icon">ğŸ“­</div>
                <p>ì´ ê°•ì˜ì— ë¶„ë¥˜ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <a href="{{ url_for('exam.unclassified_questions') }}" class="btn btn-primary"
                    style="margin-top: 1rem;">ë¬¸ì œ ë¶„ë¥˜í•˜ëŸ¬ ê°€ê¸°</a>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Keywords input cache to avoid breaking JS when keywords contain quotes
        let initialKeywords = {{ (lecture.keywords or '') | tojson }};
        const keywordInput = document.getElementById('keywordEditInput');
        document.addEventListener('DOMContentLoaded', () => {
            refreshNoteStatus();
        });

        function toggleAnswer(questionId, btn) {
            const card = document.getElementById('q-' + questionId);
            const isHidden = card.classList.contains('answer-hidden');

            if (isHidden) {
                card.classList.remove('answer-hidden');
                btn.textContent = 'ğŸ™ˆ ê°€ë¦¬ê¸°';
                btn.classList.add('showing');
            } else {
                card.classList.add('answer-hidden');
                btn.textContent = 'ğŸ‘ï¸ ì •ë‹µ';
                btn.classList.remove('showing');
            }
        }

        function showAllAnswers() {
            document.querySelectorAll('.question-card').forEach(card => {
                card.classList.remove('answer-hidden');
                const btn = card.querySelector('.toggle-answer-btn');
                btn.textContent = 'ğŸ™ˆ ê°€ë¦¬ê¸°';
                btn.classList.add('showing');
            });
        }

        function hideAllAnswers() {
            document.querySelectorAll('.question-card').forEach(card => {
                card.classList.add('answer-hidden');
                const btn = card.querySelector('.toggle-answer-btn');
                btn.textContent = 'ğŸ‘ï¸ ì •ë‹µ';
                btn.classList.remove('showing');
            });
        }

        // í‚¤ì›Œë“œ ì§ì ‘ í¸ì§‘
        function toggleKeywordEdit() {
            const editArea = document.getElementById('keywordEditArea');
            const displayArea = document.getElementById('currentKeywords');

            if (editArea.style.display === 'none') {
                editArea.style.display = 'block';
                displayArea.style.display = 'none';
                keywordInput.focus();
            } else {
                editArea.style.display = 'none';
                displayArea.style.display = 'block';
            }
        }

        function cancelKeywordEdit() {
            document.getElementById('keywordEditArea').style.display = 'none';
            document.getElementById('currentKeywords').style.display = 'block';
            // ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
            keywordInput.value = initialKeywords;
        }

        async function saveEditedKeywords() {
            const keywords = keywordInput.value;
            await saveKeywords(keywords);
            document.getElementById('keywordEditArea').style.display = 'none';
            document.getElementById('currentKeywords').style.display = 'block';
        }

        // ê°•ì˜ ë…¸íŠ¸ ì—…ë¡œë“œ
        const noteUploadArea = document.getElementById('noteUploadArea');

        if (noteUploadArea) {
            noteUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                noteUploadArea.classList.add('dragover');
            });

            noteUploadArea.addEventListener('dragleave', () => {
                noteUploadArea.classList.remove('dragover');
            });

            noteUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                noteUploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    uploadLectureNote(file);
                } else {
                    alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
            });
        }

        async function uploadLectureNote(file) {
            if (!file) return;

            const resultDiv = document.getElementById('noteUploadResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'extraction-result';
            resultDiv.innerHTML = '<div class="loading-spinner"></div> ê°•ì˜ ë…¸íŠ¸ ì¸ë±ì‹± ì¤‘...';

            const formData = new FormData();
            formData.append('pdf_file', file);

            try {
                const response = await fetch('/manage/lecture/{{ lecture.id }}/upload-note', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <strong style="color: #2ecc71;">âœ… ì¸ë±ì‹± ì™„ë£Œ!</strong>
                        <div style="margin-top: 0.5rem;">${result.pages}í˜ì´ì§€, ${result.chunks}ê°œ ì²­í¬ ìƒì„±</div>
                    `;
                    refreshNoteStatus();
                } else {
                    resultDiv.className = 'extraction-result error';
                    resultDiv.innerHTML = `<strong style="color: #e74c3c;">ì¸ë±ì‹± ì˜¤ë¥˜:</strong> ${result.error}`;
                }
            } catch (error) {
                resultDiv.className = 'extraction-result error';
                resultDiv.innerHTML = `<strong style="color: #e74c3c;">ìš”ì²­ ì‹¤íŒ¨:</strong> ${error.message}`;
            }
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        async function refreshNoteStatus() {
            const statusDiv = document.getElementById('noteStatusList');
            if (!statusDiv) return;
            try {
                const response = await fetch('/manage/lecture/{{ lecture.id }}/note-status');
                const result = await response.json();
                if (!result.success) {
                    statusDiv.innerHTML = '<span style="color: #888;">ì—…ë¡œë“œ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</span>';
                    return;
                }
                const materials = result.materials || [];
                if (!materials.length) {
                    statusDiv.innerHTML = '<span style="color: #888;">ì—…ë¡œë“œëœ ê°•ì˜ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                    return;
                }
                statusDiv.innerHTML = materials.map(m => {
                    const statusLabel = m.status === 'indexed' ? 'âœ… indexed' :
                        (m.status === 'failed' ? 'âŒ failed' : 'â³ uploaded');
                    const displayName = escapeHtml(m.originalFilename || 'lecture_note.pdf');
                    return `
                        <div style="padding: 0.6rem 0.8rem; border-radius: 8px; background: rgba(0,0,0,0.2); margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${displayName}</strong>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: #aaa; font-size: 0.8rem;">${statusLabel}</span>
                                    <button type="button" class="note-delete-btn" onclick="deleteLectureNote(${m.id})">ì‚­ì œ</button>
                                </div>
                            </div>
                            <div style="color: #888; font-size: 0.85rem; margin-top: 0.3rem;">
                                ì²­í¬ ${m.chunks}ê°œ Â· ì—…ë¡œë“œ ${m.uploadedAt ? new Date(m.uploadedAt).toLocaleString() : '-'}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: #888;">ì—…ë¡œë“œ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</span>';
            }
        }

        async function deleteLectureNote(materialId) {
            if (!materialId) return;
            if (!confirm('ì—…ë¡œë“œí•œ ê°•ì˜ë¡ì„ ì‚­ì œí• ê¹Œìš”?')) {
                return;
            }
            try {
                const response = await fetch(`/manage/lecture/{{ lecture.id }}/note/${materialId}/delete`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    refreshNoteStatus();
                } else {
                    alert('?Â¤Ã«Â¥Ëœ: ' + (result.error || '???Â¤Ã«Â¥Ëœ'));
                }
            } catch (error) {
                alert('?Â¤Ã«Â¥Ëœ: ' + error.message);
            }
        }

        async function saveKeywords(keywords) {
            try {
                const response = await fetch('/manage/lecture/{{ lecture.id }}/keywords', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keywords: keywords })
                });

                const result = await response.json();

                if (result.success) {
                    // í™”ë©´ ì—…ë°ì´íŠ¸
                    const currentKeywordsDiv = document.getElementById('currentKeywords');
                    if (keywords.trim()) {
                        const badges = keywords.split(',').map(k =>
                            `<span class="keyword-badge">${k.trim()}</span>`
                        ).join('');
                        currentKeywordsDiv.innerHTML = badges;
                    } else {
                        currentKeywordsDiv.innerHTML = '<span style="color: #666;">ë“±ë¡ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                    }

                    // í¸ì§‘ ëª¨ë“œ inputë„ ì—…ë°ì´íŠ¸
                    keywordInput.value = keywords;
                    initialKeywords = keywords;

                    // localStorageì— ì €ì¥ (ë’¤ë¡œê°€ê¸° ì‹œ ê°•ì˜ ëª©ë¡ì—ì„œ ë°˜ì˜)
                    localStorage.setItem('updatedLectureKeywords', JSON.stringify({
                        lectureId: {{ lecture.id }},
                        keywords: keywords
                    }));
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
    </script>
    <!-- Floating Action Bar -->
    <div id="floatingActionBar" class="floating-action-bar" style="display: none;">
        <span style="color:white; font-weight:bold; margin-right:1rem;"><span id="selectedCount">0</span>ê°œ ì„ íƒë¨</span>
        <button type="button" class="btn btn-primary" onclick="openMoveModal(event)">ğŸ“¦ ì´ë™</button>
        <button type="button" class="btn btn-success" onclick="runReclassification(event, this)">ğŸ¤– AI ì¬ë¶„ë¥˜</button>
        <button type="button" class="btn btn-danger" onclick="resetQuestions(event)">âŒ ë¯¸ë¶„ë¥˜ë¡œ</button>
    </div>

    <!-- ì´ë™ ëª¨ë‹¬ -->
    <div id="moveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMoveModal()">&times;</span>
            <h2>ë¬¸ì œ ì´ë™</h2>
            <p><span id="moveCount">0</span>ê°œ ë¬¸ì œë¥¼ ë‹¤ìŒ ê°•ì˜ë¡œ ì´ë™í•©ë‹ˆë‹¤:</p>
            <select id="targetLectureSelect"
                style="width: 100%; padding: 0.8rem; margin: 1rem 0; border-radius: 5px; border: 1px solid #ddd;">
                <option value="">ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
                {% for b in all_blocks %}
                <optgroup label="{{ b.name }}">
                    {% for l in b.lectures %}
                    {% if l.id != lecture.id %}
                    <option value="{{ l.id }}">{{ l.title }} ({{ l.professor or 'êµìˆ˜ ë¯¸ì •' }})</option>
                    {% endif %}
                    {% endfor %}
                </optgroup>
                {% endfor %}
            </select>
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeMoveModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitMove(event)">ì´ë™</button>
            </div>
        </div>
    </div>

    <style>
        .floating-action-bar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3436;
            padding: 1rem 2rem;
            border-radius: 50px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            gap: 1rem;
            z-index: 2147483647;
            /* Max Z-index */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal {
            z-index: 2147483647;
        }

        .checkbox-wrapper input[type="checkbox"] {
            accent-color: #667eea;
        }
    </style>

    <script>
        // --- ë¬¸ì œ ì¼ê´„ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ---
        const selectedQuestions = new Set();

        function toggleSelectAll() {
            const isChecked = document.getElementById('selectAll').checked;
            const checkboxes = document.querySelectorAll('.q-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
                if (isChecked) selectedQuestions.add(cb.value);
                else selectedQuestions.delete(cb.value);
            });
            updateActionBar();
        }

        function updateActionBar() {
            const checkboxes = document.querySelectorAll('.q-checkbox');
            selectedQuestions.clear();
            checkboxes.forEach(cb => {
                if (cb.checked) selectedQuestions.add(cb.value);
            });

            const count = selectedQuestions.size;
            document.getElementById('selectedCount').innerText = count;
            document.getElementById('moveCount').innerText = count;

            const bar = document.getElementById('floatingActionBar');
            if (count > 0) bar.style.display = 'flex';
            else bar.style.display = 'none';
        }

        function openMoveModal(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            console.log('Opening Move Modal');
            document.getElementById('moveModal').style.display = 'block';
        }

        function closeMoveModal() {
            document.getElementById('moveModal').style.display = 'none';
        }

        async function submitMove(e) {
            try {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                const targetId = document.getElementById('targetLectureSelect').value;
                if (!targetId) return alert('ì´ë™í•  ê°•ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');

                if (!confirm(selectedQuestions.size + 'ê°œ ë¬¸ì œë¥¼ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                const response = await fetch('/manage/questions/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_ids: Array.from(selectedQuestions),
                        target_lecture_id: targetId
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert(`${result.moved_count}ê°œ ë¬¸ì œê°€ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.reload();
                } else {
                    alert('ì´ë™ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (e) {
                console.error(e);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
            }
        }

        async function resetQuestions(e) {
            try {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                if (!confirm('ì„ íƒí•œ ë¬¸ì œë¥¼ "ë¯¸ë¶„ë¥˜" ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ? ë¶„ë¥˜ ëŒ€ê¸°ì†Œë¡œ ì´ë™ë©ë‹ˆë‹¤.')) return;

                const response = await fetch('/manage/questions/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_ids: Array.from(selectedQuestions)
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert(`${result.reset_count}ê°œ ë¬¸ì œê°€ ë¯¸ë¶„ë¥˜ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.reload();
                } else {
                    alert('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + result.error);
                }
            } catch (e) {
                console.error(e);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
            }
        }

        async function runReclassification(e, btn) {
            console.log('Reclassification started', btn);
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }

            if (!confirm('ì„ íƒí•œ ë¬¸ì œì— ëŒ€í•´ AI ë¶„ë¥˜ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                if (btn) {
                    btn.innerHTML = '?? ?...';
                    btn.disabled = true;
                }

                const response = await fetch('/ai/classify/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_ids: Array.from(selectedQuestions),
                        force: true
                    })
                });
                const result = await response.json();

                if (result.success) {
                    alert('AI ì¬ë¶„ë¥˜ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.href = `/ai/classify/preview/${result.job_id}`;
                } else {
                    alert('ì¬ë¶„ë¥˜ ì‹œì‘ ì‹¤íŒ¨: ' + result.error);
                    if (btn) {
                    btn.innerHTML = 'AI ???';
                        btn.disabled = false;
                    }
                }
            } catch (e) {
                console.error(e);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
                if (btn) {
                    btn.innerHTML = 'AI ???';
                    btn.disabled = false;
                }
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function (event) {
            const moveModal = document.getElementById('moveModal');
            if (moveModal && event.target == moveModal) {
                closeMoveModal();
            }
        }
    </script>
</body>

</html>
