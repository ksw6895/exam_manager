<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î∂ÑÎ•ò ÎåÄÍ∏∞ÏÜå - Í∏∞Ï∂úÎ¨∏Ï†ú Í¥ÄÎ¶¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container-fluid {
            padding: 2rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 1.8rem;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin-left: 1rem;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
        }

        /* ÏÇ¨Ïù¥ÎìúÎ∞î */
        .lecture-tree {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .lecture-tree h3 {
            font-size: 1rem;
            color: #667eea;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        .block-item {
            margin-bottom: 1rem;
        }

        .block-name {
            font-weight: bold;
            color: #aaa;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .block-name:hover {
            color: #fff;
        }

        .block-name .icon {
            transition: transform 0.2s;
        }

        .block-item.collapsed .icon {
            transform: rotate(-90deg);
        }

        .block-item.collapsed .lecture-list {
            display: none;
        }

        .lecture-list {
            margin-left: 1rem;
        }

        .lecture-item {
            padding: 0.4rem 0.8rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #ccc;
            transition: all 0.2s;
        }

        .lecture-item:hover {
            background: rgba(102, 126, 234, 0.2);
            color: #fff;
        }

        .lecture-item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .lecture-count {
            font-size: 0.75rem;
            color: #888;
            margin-left: 0.3rem;
        }

        /* ÌïÑÌÑ∞ Î∞î */
        .filter-bar {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-bar label {
            color: #aaa;
            font-size: 0.9rem;
        }

        .filter-bar select {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        .stats-badge {
            margin-left: auto;
            font-size: 0.9rem;
            color: #f39c12;
        }

        /* Ï†ÑÏ≤¥ÏÑ†ÌÉù */
        .select-all-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.8rem 1rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
        }

        .select-all-bar label {
            color: #ccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Î¨∏Ï†ú Ïπ¥Îìú Í∑∏Î¶¨Îìú */
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1.5rem;
        }

        /* Î¨∏Ï†ú Ïπ¥Îìú */
        .question-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
        }

        .question-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .question-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.15);
        }

        .question-card.assigning {
            opacity: 0.5;
            pointer-events: none;
        }

        .question-card.assigned {
            animation: fadeOut 0.5s forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: scale(0.9);
                height: 0;
                margin: 0;
                padding: 0;
            }
        }

        .card-checkbox {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #667eea;
            z-index: 10;
        }

        .card-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem 1rem 1rem 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-number {
            font-weight: bold;
            color: #667eea;
        }

        .exam-name {
            font-size: 0.8rem;
            color: #888;
        }

        .current-lecture {
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
            background: rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            color: #aaa;
        }

        .card-body {
            padding: 1.2rem;
        }

        .question-content {
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            color: #eee;
        }

        .question-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .choices-list {
            list-style: none;
            padding: 0;
        }

        .choice-item {
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            display: flex;
            gap: 0.5rem;
        }

        .choice-item.correct {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .choice-number {
            color: #667eea;
            font-weight: bold;
            min-width: 25px;
        }

        .card-footer {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .lecture-select {
            flex: 1;
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 0.9rem;
        }

        .btn-assign {
            padding: 0.5rem 1.2rem;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-assign:hover {
            transform: scale(1.05);
        }

        /* ÏùºÍ¥Ñ Î∂ÑÎ•ò Î∞î */
        .bulk-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2d3436 0%, #1a1a2e 100%);
            padding: 1rem 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.5);
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .bulk-action-bar.visible {
            transform: translateY(0);
        }

        .bulk-action-bar .selected-count {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: bold;
        }

        .bulk-action-bar select {
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            min-width: 250px;
        }

        .bulk-action-bar .btn-bulk {
            padding: 0.7rem 2rem;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }

        .bulk-action-bar .btn-cancel {
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: #aaa;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #aaa;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* Custom Confirm Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-content {
            background: linear-gradient(135deg, #2d3436 0%, #1a1a2e 100%);
            border-radius: 15px;
            padding: 2rem;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-content h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #667eea;
        }

        .modal-content p {
            margin-bottom: 1.5rem;
            color: #ccc;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .modal-btn {
            padding: 0.8rem 2rem;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-btn:hover {
            transform: scale(1.05);
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        .recent-jobs-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }

        .recent-job-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recent-job-item:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(5px);
        }

        .job-info {
            display: flex;
            flex-direction: column;
        }

        .job-time {
            font-weight: bold;
            color: #667eea;
        }

        .job-status {
            font-size: 0.85rem;
            color: #888;
        }

        .job-status.processing {
            color: #f39c12;
        }

        .job-status.completed {
            color: #2ecc71;
        }

        .job-count {
            color: #aaa;
        }
    </style>
</head>

<body>
    <!-- Custom Confirm Modal -->
    <div class="modal-overlay hidden" id="aiConfirmModal">
        <div class="modal-content">
            <h3>ü§ñ AI ÏûêÎèô Î∂ÑÎ•ò</h3>
            <p id="aiConfirmMessage">0Í∞ú Î¨∏Ï†úÎ•º AIÎ°ú Î∂ÑÎ•òÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeAIModal()">Ï∑®ÏÜå</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmAIClassification()">Î∂ÑÎ•ò ÏãúÏûë</button>
            </div>
        </div>
    </div>

    <!-- Recent Jobs Modal -->
    <div class="modal-overlay hidden" id="recentJobsModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3>üìã Ïù¥Ï†Ñ AI Î∂ÑÎ•ò Í≤∞Í≥º</h3>
            <div class="recent-jobs-list" id="recentJobsList">
                <p style="color: #888; text-align: center;">Î°úÎî© Ï§ë...</p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeRecentJobsModal()">Îã´Í∏∞</button>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <header>
            <h1>üè∑Ô∏è Î∂ÑÎ•ò ÎåÄÍ∏∞ÏÜå</h1>
            <div class="nav-links">
                <a href="{{ url_for('manage.dashboard') }}">‚Üê Í¥ÄÎ¶¨</a>
                <a href="{{ url_for('main.index') }}">Ìôà</a>
            </div>
        </header>

        <div class="main-layout">
            <aside class="lecture-tree">
                <h3>üìö Í∞ïÏùò ÏÑ†ÌÉù</h3>
                {% if blocks %}
                {% for block in blocks %}
                <div class="block-item">
                    <div class="block-name" onclick="toggleBlock(this.parentElement)">
                        <span class="icon">‚ñº</span>
                        {{ block.name }}
                    </div>
                    <div class="lecture-list">
                        {% for lecture in block.lectures %}
                        <div class="lecture-item" data-lecture-id="{{ lecture.id }}"
                            onclick="selectLecture(this, {{ lecture.id }}, '{{ block.name }} > {{ lecture.title }}')">
                            {{ lecture.order }}Í∞ï. {{ lecture.title }}
                            <span class="lecture-count">({{ lecture.question_count }})</span>
                        </div>
                        {% endfor %}
                        {% if not block.lectures.count() %}
                        <div style="color: #666; font-size: 0.85rem; padding: 0.5rem;">Í∞ïÏùò ÏóÜÏùå</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p style="color: #666; font-size: 0.9rem;">Î∏îÎ°ùÏùÑ Î®ºÏ†Ä ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.</p>
                {% endif %}
            </aside>

            <main>
                <div class="filter-bar">
                    <input type="text" id="searchInput" placeholder="üîç Î¨∏Ï†ú ÎÇ¥Ïö© Í≤ÄÏÉâ..."
                        style="flex: 1; padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff;"
                        oninput="filterQuestions()">
                    <label>ÏãúÌóò:</label>
                    <select id="examFilter" onchange="filterQuestions()">
                        <option value="all">Ï†ÑÏ≤¥</option>
                        {% for exam in exams %}
                        <option value="{{ exam.id }}">{{ exam.title }}</option>
                        {% endfor %}
                    </select>
                    <label>ÏÉÅÌÉú:</label>
                    <select id="statusFilter" onchange="filterQuestions()">
                        <option value="unclassified">ÎØ∏Î∂ÑÎ•òÎßå</option>
                        <option value="classified">Î∂ÑÎ•òÎê®</option>
                        <option value="all">Ï†ÑÏ≤¥</option>
                    </select>
                    <span class="stats-badge">
                        üìä ÎØ∏Î∂ÑÎ•ò: <strong id="unclassifiedCount">{{ unclassified_count }}</strong>Í∞ú
                    </span>
                </div>

                <div class="select-all-bar">
                    <label>
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        Ï†ÑÏ≤¥ ÏÑ†ÌÉù
                    </label>
                    <span id="selectedInfo" style="color: #667eea;"></span>
                    <button onclick="startAIClassification()"
                        style="margin-left: auto; padding: 0.6rem 1.2rem; border-radius: 8px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                        ü§ñ AI ÏûêÎèô Î∂ÑÎ•ò
                    </button>
                    <button onclick="showRecentJobs()"
                        style="padding: 0.6rem 1.2rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: transparent; color: #aaa; cursor: pointer;">
                        üìã Ïù¥Ï†Ñ Í≤∞Í≥º
                    </button>
                </div>

                <div class="questions-grid" id="questionsGrid">
                    {% if questions %}
                    {% for question in questions %}
                    <div class="question-card" data-question-id="{{ question.id }}"
                        data-exam-id="{{ question.exam_id }}"
                        data-classified="{{ 'true' if question.is_classified else 'false' }}"
                        data-content="{{ (question.content or '')|lower }}">
                        <input type="checkbox" class="card-checkbox" data-id="{{ question.id }}"
                            onchange="updateSelection()">
                        <div class="card-header">
                            <div>
                                <span class="question-number">Q{{ question.question_number }}</span>
                                <span class="exam-name">{{ question.exam.title }}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                {% if question.lecture %}
                                <span class="current-lecture">{{ question.lecture.block.name }} > {{
                                    question.lecture.title }}</span>
                                {% endif %}
                                <a href="{{ url_for('manage.edit_question', question_id=question.id) }}" target="_blank"
                                    style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: rgba(255,255,255,0.1); border-radius: 4px; color: #aaa; text-decoration: none;"
                                    title="ÏÉà Ï∞ΩÏóêÏÑú ÏàòÏ†ï">‚úèÔ∏è</a>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if question.image_path %}
                            <img src="{{ url_for('static', filename='uploads/' + question.image_path) }}"
                                class="question-image" alt="Î¨∏Ï†ú Ïù¥ÎØ∏ÏßÄ">
                            {% endif %}
                            <div class="question-content">{{ question.content[:200] if question.content else '(Ïù¥ÎØ∏ÏßÄ Î¨∏Ï†ú)'
                                }}{% if question.content and question.content|length > 200 %}...{% endif %}</div>
                            <ul class="choices-list">
                                {% for choice in question.choices %}
                                <li class="choice-item {{ 'correct' if choice.is_correct else '' }}">
                                    <span class="choice-number">{{ choice.choice_number }}.</span>
                                    <span>{{ choice.content[:50] }}{% if choice.content|length > 50 %}...{% endif
                                        %}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="card-footer">
                            <select class="lecture-select" id="select-{{ question.id }}">
                                <option value="">Í∞ïÏùò ÏÑ†ÌÉù...</option>
                                {% for block in blocks %}
                                <optgroup label="{{ block.name }}">
                                    {% for lecture in block.lectures %}
                                    <option value="{{ lecture.id }}" {{ 'selected' if question.lecture_id==lecture.id
                                        else '' }}>
                                        {{ lecture.order }}Í∞ï. {{ lecture.title }}
                                    </option>
                                    {% endfor %}
                                </optgroup>
                                {% endfor %}
                            </select>
                            <button class="btn-assign" onclick="assignQuestion({{ question.id }})">
                                {{ 'Ïù¥Îèô' if question.is_classified else 'Î∞∞Ï†ï' }}
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="icon">üéâ</div>
                        <p>Î™®Îì† Î¨∏Ï†úÍ∞Ä Î∂ÑÎ•òÎêòÏóàÏäµÎãàÎã§!</p>
                    </div>
                    {% endif %}
                </div>
            </main>
        </div>
    </div>

    <!-- ÏùºÍ¥Ñ Î∂ÑÎ•ò Î∞î -->
    <div class="bulk-action-bar" id="bulkActionBar">
        <span class="selected-count"><span id="bulkCount">0</span>Í∞ú ÏÑ†ÌÉùÎê®</span>
        <select id="bulkLectureSelect">
            <option value="">Î∂ÑÎ•òÌï† Í∞ïÏùò ÏÑ†ÌÉù...</option>
            {% for block in blocks %}
            <optgroup label="{{ block.name }}">
                {% for lecture in block.lectures %}
                <option value="{{ lecture.id }}">{{ lecture.order }}Í∞ï. {{ lecture.title }}</option>
                {% endfor %}
            </optgroup>
            {% endfor %}
        </select>
        <button class="btn-bulk" onclick="bulkClassify()">ÏùºÍ¥Ñ Î∂ÑÎ•ò</button>
        <button class="btn-cancel" onclick="clearSelection()">Ï∑®ÏÜå</button>
    </div>

    <script>
        let selectedLectureId = null;
        let selectedIds = new Set();

        function toggleBlock(blockElement) {
            blockElement.classList.toggle('collapsed');
        }

        function selectLecture(element, lectureId, lectureName) {
            document.querySelectorAll('.lecture-item.selected').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedLectureId = lectureId;

            // Î™®Îì† ÎìúÎ°≠Îã§Ïö¥Í≥º Î≤åÌÅ¨ ÏÖÄÎ†âÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
            document.querySelectorAll('.lecture-select').forEach(s => s.value = lectureId);
            document.getElementById('bulkLectureSelect').value = lectureId;
        }

        function filterQuestions() {
            const examFilter = document.getElementById('examFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();

            document.querySelectorAll('.question-card').forEach(card => {
                const examId = card.dataset.examId;
                const isClassified = card.dataset.classified === 'true';
                const content = card.dataset.content || '';
                let show = true;

                // ÏãúÌóò ÌïÑÌÑ∞
                if (examFilter !== 'all' && examId !== examFilter) show = false;

                // ÏÉÅÌÉú ÌïÑÌÑ∞
                if (statusFilter === 'unclassified' && isClassified) show = false;
                else if (statusFilter === 'classified' && !isClassified) show = false;

                // Í≤ÄÏÉâÏñ¥ ÌïÑÌÑ∞
                if (searchQuery && !content.includes(searchQuery)) show = false;

                card.style.display = show ? '' : 'none';
            });
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.question-card:not([style*="display: none"]) .card-checkbox').forEach(cb => {
                cb.checked = checked;
            });
            updateSelection();
        }

        function updateSelection() {
            selectedIds.clear();
            document.querySelectorAll('.card-checkbox:checked').forEach(cb => {
                selectedIds.add(parseInt(cb.dataset.id));
                cb.closest('.question-card').classList.add('selected');
            });
            document.querySelectorAll('.card-checkbox:not(:checked)').forEach(cb => {
                cb.closest('.question-card').classList.remove('selected');
            });

            const count = selectedIds.size;
            document.getElementById('bulkCount').textContent = count;
            document.getElementById('selectedInfo').textContent = count > 0 ? `${count}Í∞ú ÏÑ†ÌÉùÎê®` : '';
            document.getElementById('bulkActionBar').classList.toggle('visible', count > 0);
        }

        function clearSelection() {
            document.querySelectorAll('.card-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAll').checked = false;
            updateSelection();
        }

        async function bulkClassify() {
            const lectureId = document.getElementById('bulkLectureSelect').value;
            if (!lectureId) {
                alert('Î∂ÑÎ•òÌï† Í∞ïÏùòÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            if (selectedIds.size === 0) {
                alert('Î¨∏Ï†úÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const questionIds = Array.from(selectedIds);

            try {
                const response = await fetch('/exam/questions/bulk-classify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_ids: questionIds, lecture_id: parseInt(lectureId) })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`${result.updated_count}Í∞ú Î¨∏Ï†úÍ∞Ä "${result.lecture_name}"Î°ú Î∂ÑÎ•òÎêòÏóàÏäµÎãàÎã§.`);

                    // Î∂ÑÎ•òÎêú Ïπ¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
                    const statusFilter = document.getElementById('statusFilter').value;
                    questionIds.forEach(id => {
                        const card = document.querySelector(`.question-card[data-question-id="${id}"]`);
                        if (card) {
                            card.dataset.classified = 'true';
                            if (statusFilter === 'unclassified') {
                                card.classList.add('assigned');
                                setTimeout(() => card.remove(), 500);
                            }
                        }
                    });

                    clearSelection();
                    updateUnclassifiedCount();
                } else {
                    alert('Î∂ÑÎ•ò Ïã§Ìå®: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        async function assignQuestion(questionId) {
            const select = document.getElementById(`select-${questionId}`);
            const lectureId = select.value;
            if (!lectureId) { alert('Í∞ïÏùòÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'); return; }

            const card = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
            card.classList.add('assigning');

            try {
                const formData = new FormData();
                formData.append('lecture_id', lectureId);
                const response = await fetch(`/exam/question/${questionId}/classify`, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const result = await response.json();

                if (result.success) {
                    card.dataset.classified = 'true';
                    card.classList.remove('assigning');
                    if (document.getElementById('statusFilter').value === 'unclassified') {
                        card.classList.add('assigned');
                        setTimeout(() => card.remove(), 500);
                    }
                    updateUnclassifiedCount();
                } else {
                    alert('Î∂ÑÎ•ò Ïã§Ìå®: ' + result.error);
                    card.classList.remove('assigning');
                }
            } catch (error) {
                console.error('Error:', error);
                card.classList.remove('assigning');
            }
        }

        function updateUnclassifiedCount() {
            const count = document.querySelectorAll('.question-card[data-classified="false"]').length;
            document.getElementById('unclassifiedCount').textContent = count;
        }

        filterQuestions();

        // AI ÏûêÎèô Î∂ÑÎ•ò - Î™®Îã¨ Í¥ÄÎ†® Î≥ÄÏàò
        let pendingQuestionIds = [];

        function startAIClassification() {
            // ÏÑ†ÌÉùÎêú Î¨∏Ï†úÍ∞Ä ÏóÜÏúºÎ©¥ ÎØ∏Î∂ÑÎ•ò Î¨∏Ï†ú Ï†ÑÏ≤¥ ÏÑ†ÌÉù
            let questionIds = Array.from(selectedIds);

            if (questionIds.length === 0) {
                // ÎØ∏Î∂ÑÎ•ò Î¨∏Ï†úÎßå ÏÑ†ÌÉù
                questionIds = Array.from(document.querySelectorAll('.question-card[data-classified="false"]'))
                    .map(card => parseInt(card.dataset.questionId));
            }

            if (questionIds.length === 0) {
                showAlert('Î∂ÑÎ•òÌï† Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // Î™®Îã¨ ÌëúÏãú
            pendingQuestionIds = questionIds;
            document.getElementById('aiConfirmMessage').textContent =
                `${questionIds.length}Í∞ú Î¨∏Ï†úÎ•º AIÎ°ú Î∂ÑÎ•òÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
            document.getElementById('aiConfirmModal').classList.remove('hidden');
        }

        function closeAIModal() {
            document.getElementById('aiConfirmModal').classList.add('hidden');
            pendingQuestionIds = [];
        }

        async function confirmAIClassification() {
            // Ï§ëÏöî: closeAIModalÏù¥ pendingQuestionIdsÎ•º Ï¥àÍ∏∞ÌôîÌïòÎØÄÎ°ú Î®ºÏ†Ä Î≥µÏÇ¨
            const questionIds = [...pendingQuestionIds];
            closeAIModal();

            if (questionIds.length === 0) return;

            try {
                const response = await fetch('/ai/classify/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_ids: questionIds })
                });

                const result = await response.json();

                if (result.success) {
                    // Preview ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                    window.location.href = `/ai/classify/preview/${result.job_id}`;
                } else {
                    showAlert('AI Î∂ÑÎ•ò ÏãúÏûë Ïã§Ìå®: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        function showAlert(message) {
            // Í∞ÑÎã®Ìïú ÏïåÎ¶º ÌëúÏãú (alert ÎåÄÏã†)
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#e74c3c;color:white;padding:1rem 2rem;border-radius:8px;z-index:10000;animation:fadeIn 0.3s;';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        // Ïù¥Ï†Ñ AI Î∂ÑÎ•ò Í≤∞Í≥º Í¥ÄÎ†®
        async function showRecentJobs() {
            document.getElementById('recentJobsModal').classList.remove('hidden');
            document.getElementById('recentJobsList').innerHTML = '<p style="color: #888; text-align: center;">Î°úÎî© Ï§ë...</p>';

            try {
                const response = await fetch('/ai/classify/recent');
                const data = await response.json();

                if (!data.success) {
                    document.getElementById('recentJobsList').innerHTML = '<p style="color: #e74c3c; text-align: center;">Î°úÎìú Ïã§Ìå®</p>';
                    return;
                }

                if (data.jobs.length === 0) {
                    document.getElementById('recentJobsList').innerHTML = '<p style="color: #888; text-align: center;">ÏµúÍ∑º 7Ïùº Ïù¥ÎÇ¥ AI Î∂ÑÎ•ò Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                    return;
                }

                let html = '';
                data.jobs.forEach(job => {
                    html += `
                        <div class="recent-job-item" onclick="window.location.href='/ai/classify/preview/${job.id}'">
                            <div class="job-info">
                                <span class="job-time">${job.created_at}</span>
                                <span class="job-status ${job.status}">${job.status_label}</span>
                            </div>
                            <span class="job-count">${job.total_count}Î¨∏Ï†ú</span>
                        </div>
                    `;
                });
                document.getElementById('recentJobsList').innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('recentJobsList').innerHTML = '<p style="color: #e74c3c; text-align: center;">Ïò§Î•ò Î∞úÏÉù</p>';
            }
        }

        function closeRecentJobsModal() {
            document.getElementById('recentJobsModal').classList.add('hidden');
        }
    </script>
</body>

</html>