<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Î∂ÑÎ•ò Í≤∞Í≥º - Í∏∞Ï∂úÎ¨∏Ï†ú Í¥ÄÎ¶¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin-left: 1rem;
        }

        /* ÏßÑÌñâ ÏÉÅÌÉú Î∞î */
        .progress-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-bar-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            color: #aaa;
            font-size: 0.9rem;
        }

        .progress-stats span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        /* ÌïÑÌÑ∞ Î∞î */
        .filter-bar {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-bar button {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-bar button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }

        .filter-bar button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Í≤∞Í≥º ÏòÅÏó≠ */
        .results-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .block-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
        }

        .block-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .block-header .icon {
            transition: transform 0.2s;
        }

        .block-section.collapsed .block-header .icon {
            transform: rotate(-90deg);
        }

        .block-section.collapsed .block-content {
            display: none;
        }

        .block-content {
            padding: 1rem;
        }

        .lecture-group {
            margin-bottom: 1rem;
        }

        .lecture-header {
            padding: 0.5rem 1rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lecture-title {
            color: #667eea;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .lecture-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }

        /* Î¨∏Ï†ú Ïπ¥Îìú */
        .question-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .question-item.selected {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.5);
        }

        .question-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .question-info {
            flex: 1;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .question-number {
            font-weight: bold;
            color: #667eea;
        }

        .exam-name {
            color: #888;
            font-size: 0.8rem;
        }

        .confidence-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .confidence-high {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .confidence-medium {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }

        .confidence-low {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .question-content {
            font-size: 0.9rem;
            color: #ddd;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .ai-reason {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.5rem 0.8rem;
            font-size: 0.85rem;
            color: #aaa;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .ai-reason .icon {
            color: #f39c12;
        }

        .ai-evidence {
            margin-top: 0.6rem;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            font-size: 0.85rem;
            color: #ccc;
            line-height: 1.5;
        }

        .ai-evidence .label {
            color: #2ecc71;
            font-weight: bold;
        }

        .ai-evidence .snippet {
            color: #ddd;
            margin-top: 0.3rem;
        }

        .ai-evidence .hint {
            color: #aaa;
            margin-top: 0.3rem;
        }

        .card-view {
            width: 100%;
            max-width: 960px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .card-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .card-index {
            color: #aaa;
            font-size: 0.9rem;
        }

        .card-btn {
            padding: 0.5rem 1.1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            color: #ddd;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .card-btn:hover:not(:disabled) {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.6);
            color: #fff;
        }

        .card-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .card-panel {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 1.6rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            color: #667eea;
            font-weight: 700;
        }

        .exam-tag {
            display: inline-block;
            margin-left: 0.5rem;
            color: #aaa;
            font-size: 0.85rem;
            font-weight: 400;
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.4rem;
            align-items: center;
        }

        .lecture-tag {
            background: rgba(102, 126, 234, 0.15);
            color: #cdd4ff;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.75rem;
        }

        .lecture-tag.no-match {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .card-badge {
            padding: 0.3rem 0.7rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-match {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .badge-no-match {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .card-question {
            margin-top: 1.2rem;
            background: rgba(0, 0, 0, 0.25);
            padding: 1rem;
            border-radius: 12px;
        }

        .card-question-text {
            color: #eee;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-top: 0.4rem;
        }

        .choice-list {
            margin-top: 0.8rem;
            padding-left: 1.2rem;
            color: #ddd;
            font-size: 0.9rem;
        }

        .choice-list li {
            margin-bottom: 0.4rem;
        }

        .card-section {
            margin-top: 1rem;
            background: rgba(0, 0, 0, 0.22);
            border-radius: 12px;
            padding: 1rem;
        }

        .card-section-title {
            font-size: 0.85rem;
            color: #2ecc71;
            font-weight: 600;
            margin-bottom: 0.4rem;
        }

        .card-section-body {
            color: #ddd;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .card-actions-row {
            display: flex;
            justify-content: flex-end;
            gap: 0.6rem;
        }

        .card-actions-row .card-btn {
            border-radius: 10px;
        }

        .card-btn.card-apply {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }

        .card-btn.card-select {
            background: rgba(255, 255, 255, 0.08);
        }

        .empty-card {
            padding: 2rem;
            text-align: center;
            color: #aaa;
        }

        .muted {
            color: #888;
        }

        .question-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .btn-action {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-change {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }

        .btn-reject {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        /* No Match ÏÑπÏÖò */
        .no-match-section {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .no-match-section .block-header {
            background: rgba(231, 76, 60, 0.2);
        }

        /* ÌïòÎã® Ïï°ÏÖò Î∞î */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2d3436 0%, #1a1a2e 100%);
            padding: 1rem 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .action-bar .selected-count {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: bold;
        }

        .btn-apply {
            padding: 0.8rem 2rem;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-apply:hover {
            transform: scale(1.05);
        }

        .btn-apply:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-apply-all {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-cancel {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: #aaa;
            cursor: pointer;
        }

        /* Î°úÎî© ÏÉÅÌÉú */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 1rem;
            color: #ccc;
        }

        /* Îπà ÏÉÅÌÉú */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #aaa;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* Î∞òÏùëÌòï Ïó¨Î∞± */
        .results-container {
            padding-bottom: 100px;
        }

        /* Custom Confirm Modal */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .confirm-modal-overlay.hidden {
            display: none;
        }

        .confirm-modal-content {
            background: linear-gradient(135deg, #2d3436 0%, #1a1a2e 100%);
            border-radius: 15px;
            padding: 2rem;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .confirm-modal-content h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #667eea;
        }

        .confirm-modal-content p {
            margin-bottom: 1.5rem;
            color: #ccc;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .confirm-modal-btn {
            padding: 0.8rem 2rem;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .confirm-modal-btn:hover {
            transform: scale(1.05);
        }

        .confirm-modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .confirm-modal-btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .confirm-modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        .toast-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 8px;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .toast-error {
            background: #e74c3c;
            color: white;
        }

        .toast-success {
            background: #2ecc71;
            color: white;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <!-- Custom Confirm Modal -->
    <div class="confirm-modal-overlay hidden" id="confirmModal">
        <div class="confirm-modal-content">
            <h3 id="confirmModalTitle">ÌôïÏù∏</h3>
            <p id="confirmModalMessage">ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
            <div class="confirm-modal-buttons">
                <button class="confirm-modal-btn confirm-modal-btn-secondary" onclick="closeConfirmModal()">Ï∑®ÏÜå</button>
                <button class="confirm-modal-btn confirm-modal-btn-primary" id="confirmModalBtn"
                    onclick="executeConfirmedAction()">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>ü§ñ AI Î∂ÑÎ•ò Í≤∞Í≥º</h1>
            <div class="nav-links">
                <a href="{{ url_for('exam.unclassified_questions') }}">‚Üê Î∂ÑÎ•ò ÎåÄÍ∏∞ÏÜå</a>
                <a href="{{ url_for('main.index') }}">Ìôà</a>
            </div>
        </header>

        <!-- ÏßÑÌñâ ÏÉÅÌÉú -->
        <section class="progress-section" id="progressSection">
            <div class="progress-header">
                <span id="progressTitle">Î∂ÑÎ•ò ÏßÑÌñâ Ï§ë...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="progress-stats">
                <span>‚úÖ ÏÑ±Í≥µ: <strong id="successCount">0</strong></span>
                <span>‚ùå Ïã§Ìå®: <strong id="failedCount">0</strong></span>
                <span>üìä Ï†ÑÏ≤¥: <strong id="totalCount">0</strong></span>
            </div>
        </section>

        <!-- ÌïÑÌÑ∞ Î∞î -->
        <div class="filter-bar" id="filterBar" style="display: none;">
            <button class="active" data-filter="all">Ï†ÑÏ≤¥ Î≥¥Í∏∞</button>
            <button data-filter="high">‚úÖ ÌôïÏã§Ìïú Ï†úÏïà</button>
            <button data-filter="low">‚ö†Ô∏è Í≤ÄÌÜ† ÌïÑÏöî</button>
            <button data-filter="nomatch">‚ùì Î∂ÑÎ•ò Î∂àÍ∞Ä</button>
            <span style="margin-left: auto; color: #888;" id="filterInfo"></span>
        </div>

        <!-- Í≤∞Í≥º ÏòÅÏó≠ -->
        <div class="results-container" id="resultsContainer" style="display: none;">
            <!-- JavaScriptÎ°ú ÎèôÏ†Å ÏÉùÏÑ± -->
        </div>

        <!-- Îπà ÏÉÅÌÉú (Ï≤òÎ¶¨ Ï†Ñ) -->
        <div class="empty-state" id="emptyState">
            <div class="icon">‚è≥</div>
            <p>AIÍ∞Ä Î¨∏Ï†úÎ•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...</p>
        </div>
    </div>

    <!-- ÌïòÎã® Ïï°ÏÖò Î∞î -->
    <div class="action-bar" id="actionBar" style="display: none;">
        <span class="selected-count"><span id="selectedCount">0</span>Í∞ú ÏÑ†ÌÉùÎê®</span>
        <button class="btn-apply btn-apply-all" onclick="applyHighConfidence()">ÌôïÏã§Ìïú Ï†úÏïàÎßå Ï†ÅÏö©</button>
        <button class="btn-apply" onclick="applySelected()" id="applySelectedBtn" disabled>ÏÑ†ÌÉù Ìï≠Î™© Ï†ÅÏö©</button>
        <button class="btn-cancel"
            onclick="window.location.href='{{ url_for('exam.unclassified_questions') }}'">Ï∑®ÏÜå</button>
    </div>

    <!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
        <p class="loading-text">Ï†ÅÏö© Ï§ë...</p>
    </div>

    <script>
        const JOB_ID = {{ job.id }};
        const CONFIDENCE_THRESHOLD = 0.7;
        let resultsData = null;
        let selectedIds = new Set();
        let pollingInterval = null;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÉÅÌÉú ÌôïÏù∏ ÏãúÏûë
        document.addEventListener('DOMContentLoaded', () => {
            startPolling();
        });

        function startPolling() {
            checkStatus();
            pollingInterval = setInterval(checkStatus, 1000);
        }

        async function checkStatus() {
            try {
                const response = await fetch(`/ai/classify/status/${JOB_ID}`);
                const data = await response.json();

                if (!data.success) {
                    showError(data.error);
                    stopPolling();
                    return;
                }

                updateProgress(data);

                if (data.is_complete) {
                    stopPolling();
                    if (data.status === 'completed') {
                        await loadResults();
                    } else {
                        showError(data.error_message || 'ÏûëÏóÖ Ïã§Ìå®');
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        function updateProgress(data) {
            document.getElementById('progressBar').style.width = `${data.progress_percent}%`;
            document.getElementById('progressPercent').textContent = `${data.progress_percent}%`;
            document.getElementById('successCount').textContent = data.success_count;
            document.getElementById('failedCount').textContent = data.failed_count;
            document.getElementById('totalCount').textContent = data.total_count;

            if (data.status === 'processing') {
                document.getElementById('progressTitle').textContent =
                    `Î∂ÑÎ•ò ÏßÑÌñâ Ï§ë... (${data.processed_count}/${data.total_count})`;
            } else if (data.status === 'completed') {
                document.getElementById('progressTitle').textContent = 'Î∂ÑÎ•ò ÏôÑÎ£å!';
            }
        }

        async function loadResults() {
            try {
                const response = await fetch(`/ai/classify/result/${JOB_ID}`);
                const data = await response.json();

                if (!data.success) {
                    showError(data.error);
                    return;
                }

                resultsData = data;
                renderResults(data);

                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('filterBar').style.display = 'flex';
                document.getElementById('resultsContainer').style.display = 'flex';
                document.getElementById('actionBar').style.display = 'flex';

            } catch (error) {
                showError('\uACB0\uACFC \uB85C\uB4DC \uC2E4\uD328: ' + error.message);
            }
        }

        let allItems = [];
        let filteredItems = [];
        let currentIndex = 0;
        let activeFilter = 'all';

        function renderResults(data) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="card-view" id="cardView">
                    <div class="card-nav">
                        <button class="card-btn" id="prevBtn" onclick="goPrev()">\uC774\uC804</button>
                        <div class="card-index" id="cardIndex"></div>
                        <button class="card-btn" id="nextBtn" onclick="goNext()">\uB2E4\uC74C</button>
                    </div>
                    <div class="card-panel" id="cardPanel"></div>
                    <div class="card-actions-row">
                        <button class="card-btn card-select" id="cardSelectBtn" onclick="toggleCurrentSelection()">\uC774 \uBB38\uC81C \uC120\uD0DD</button>
                        <button class="card-btn card-apply" id="cardApplyBtn" onclick="applyCurrent()">\uC774 \uBB38\uC81C \uC801\uC6A9</button>
                    </div>
                </div>
            `;

            allItems = buildFlatItems(data);
            filteredItems = allItems.slice();
            currentIndex = 0;
            initSelectedFromConfidence();
            renderCard();
            updateFilterInfo();
        }

        function buildFlatItems(data) {
            const items = [];
            (data.grouped_results || []).forEach(block => {
                (block.lectures || []).forEach(lecture => {
                    (lecture.questions || []).forEach(q => {
                        items.push({
                            ...q,
                            block_name: block.block_name,
                            lecture_title: lecture.lecture_title,
                            lecture_id: lecture.lecture_id,
                            no_match: false
                        });
                    });
                });
            });

            (data.no_match_list || []).forEach(q => {
                items.push({
                    ...q,
                    block_name: q.block_name || '',
                    lecture_title: q.lecture_title || '\uBD84\uB958 \uBD88\uAC00',
                    lecture_id: null,
                    no_match: true
                });
            });

            items.sort((a, b) => (a.question_id || 0) - (b.question_id || 0));
            return items;
        }

        function initSelectedFromConfidence() {
            selectedIds = new Set();
            allItems.forEach(item => {
                const confidence = item.confidence || 0;
                if (item.lecture_id && confidence >= CONFIDENCE_THRESHOLD) {
                    selectedIds.add(item.question_id);
                }
            });
            updateSelectedCount();
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function formatPageRange(evidence) {
            if (!evidence) return '';
            const start = evidence.page_start;
            const end = evidence.page_end;
            if (start === null || start === undefined) return '';
            if (end === null || end === undefined || start === end) {
                return `p.${start}`;
            }
            return `p.${start}-${end}`;
        }

        function buildEvidenceHtml(q) {
            const evidence = Array.isArray(q.evidence) ? q.evidence : [];
            const hint = q.study_hint || '';
            if (!evidence.length && !hint) {
                return '';
            }

            const pageLabels = evidence.slice(0, 2).map(formatPageRange).filter(Boolean);
            const pageText = pageLabels.length ? `\uCD94\uCC9C \uD398\uC774\uC9C0: ${pageLabels.join(', ')}` : '';
            const snippet = evidence.length ? (evidence[0].quote || '') : '';
            const snippetHtml = snippet ? `<div class="snippet">${escapeHtml(snippet)}</div>` : '';
            const hintHtml = hint ? `<div class="hint">\uACF5\uBD80 \uD3EC\uC778\uD2B8: ${escapeHtml(hint)}</div>` : '';

            return `
                <div class="ai-evidence">
                    ${pageText ? `<div class="label">${pageText}</div>` : ''}
                    ${snippetHtml}
                    ${hintHtml}
                </div>
            `;
        }

        function renderCard() {
            const panel = document.getElementById('cardPanel');
            const indexEl = document.getElementById('cardIndex');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const selectBtn = document.getElementById('cardSelectBtn');
            const applyBtn = document.getElementById('cardApplyBtn');

            if (!filteredItems.length) {
                panel.innerHTML = '<div class="empty-card">\uC870\uAC74\uC5D0 \uB9DE\uB294 \uACB0\uACFC\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</div>';
                indexEl.textContent = '0 / 0';
                if (prevBtn) prevBtn.disabled = true;
                if (nextBtn) nextBtn.disabled = true;
                if (selectBtn) {
                    selectBtn.disabled = true;
                    selectBtn.textContent = '\uC774 \uBB38\uC81C \uC120\uD0DD';
                }
                if (applyBtn) applyBtn.disabled = true;
                return;
            }

            const item = filteredItems[currentIndex];
            const confidence = item.confidence || 0;
            const confidenceClass = confidence >= 0.8 ? 'high' : (confidence >= 0.6 ? 'medium' : 'low');
            const confidenceLabel = confidence >= 0.8 ? '\uB192\uC74C' : (confidence >= 0.6 ? '\uBCF4\uD1B5' : '\uB0AE\uC74C');
            const isSelected = selectedIds.has(item.question_id);
            const blockName = item.block_name ? `${item.block_name} > ` : '';
            const lectureLabel = item.lecture_id ? `${blockName}${item.lecture_title || ''}`.trim() : '\uBD84\uB958 \uBD88\uAC00';
            const questionText = item.question_content || item.question_text || '';
            const questionHtml = questionText
                ? escapeHtml(questionText).replace(/\n/g, '<br>')
                : '<span class="muted">\uBB38\uD56D \uD14D\uC2A4\uD2B8 \uC5C6\uC74C</span>';
            const choices = Array.isArray(item.question_choices) ? item.question_choices : [];
            const choicesHtml = choices.length
                ? `<ol class="choice-list">${choices.map(c => `<li>${escapeHtml(c)}</li>`).join('')}</ol>`
                : '';
            const reasonText = item.reason || '\uBD84\uB958 \uADFC\uAC70 \uC5C6\uC74C';
            const evidenceHtml = buildEvidenceHtml(item);

            panel.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="card-title">Q${item.question_number}
                            <span class="exam-tag">${escapeHtml(item.exam_title || '')}</span>
                        </div>
                        <div class="card-meta">
                            <span class="lecture-tag ${item.lecture_id ? '' : 'no-match'}">${escapeHtml(lectureLabel)}</span>
                            <span class="confidence-badge confidence-${confidenceClass}">
                                ${Math.round(confidence * 100)}% ${confidenceLabel}
                            </span>
                        </div>
                    </div>
                    <div class="card-badge ${item.no_match ? 'badge-no-match' : 'badge-match'}">
                        ${item.no_match ? '\uBD84\uB958 \uBD88\uAC00' : '\uBD84\uB958\uB428'}
                    </div>
                </div>
                <div class="card-question">
                    <div class="card-section-title">\uBB38\uC81C</div>
                    <div class="card-question-text">${questionHtml}</div>
                    ${choicesHtml}
                </div>
                <div class="card-section">
                    <div class="card-section-title">AI \uBD84\uB958 \uAE30\uC900</div>
                    <div class="card-section-body">${escapeHtml(reasonText)}</div>
                </div>
                <div class="card-section">
                    <div class="card-section-title">\uACF5\uBD80 \uB808\uD37C\uB7F0\uC2A4</div>
                    ${evidenceHtml || '<div class="card-section-body muted">\uC81C\uACF5\uB41C \uADFC\uAC70\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</div>'}
                </div>
            `;

            indexEl.textContent = `${currentIndex + 1} / ${filteredItems.length}`;
            if (prevBtn) prevBtn.disabled = currentIndex === 0;
            if (nextBtn) nextBtn.disabled = currentIndex >= filteredItems.length - 1;
            if (selectBtn) {
                selectBtn.disabled = !item.lecture_id;
                selectBtn.textContent = isSelected ? '\uC120\uD0DD \uD574\uC81C' : '\uC774 \uBB38\uC81C \uC120\uD0DD';
            }
            if (applyBtn) applyBtn.disabled = !item.lecture_id;
        }

        function goPrev() {
            if (currentIndex > 0) {
                currentIndex -= 1;
                renderCard();
            }
        }

        function goNext() {
            if (currentIndex < filteredItems.length - 1) {
                currentIndex += 1;
                renderCard();
            }
        }

        function toggleCurrentSelection() {
            const item = filteredItems[currentIndex];
            if (!item || !item.lecture_id) {
                showToast('\uC801\uC6A9 \uAC00\uB2A5\uD55C \uAC15\uC758\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.');
                return;
            }
            if (selectedIds.has(item.question_id)) {
                selectedIds.delete(item.question_id);
            } else {
                selectedIds.add(item.question_id);
            }
            updateSelectedCount();
            renderCard();
        }

        function applyCurrent() {
            const item = filteredItems[currentIndex];
            if (!item || !item.lecture_id) {
                showToast('\uC801\uC6A9 \uAC00\uB2A5\uD55C \uAC15\uC758\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.');
                return;
            }
            pendingIds = [item.question_id];
            showConfirmModal(
                '\uD604\uC7AC \uBB38\uC81C \uC801\uC6A9',
                '\uC774 \uBB38\uC81C\uC758 \uBD84\uB958 \uACB0\uACFC\uB97C \uC801\uC6A9\uD560\uAE4C\uC694?',
                'confirm-modal-btn-primary',
                applyClassification
            );
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedIds.size;
            document.getElementById('applySelectedBtn').disabled = selectedIds.size === 0;
        }

        function updateFilterInfo() {
            const highCount = allItems.filter(item => (item.confidence || 0) >= 0.7 && item.lecture_id).length;
            document.getElementById('filterInfo').textContent = `\uD655\uC2E4 \uCD94\uCC9C: ${highCount}\uAC1C`;
        }

        // \uD544\uD130 \uBC84\uD2BC \uCC98\uB9AC
        document.querySelectorAll('.filter-bar button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-bar button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                applyFilter(btn.dataset.filter);
            });
        });

        function applyFilter(filter) {
            activeFilter = filter;
            filteredItems = allItems.filter(item => {
                const confidence = item.confidence || 0;
                const hasLecture = Boolean(item.lecture_id);
                if (filter === 'high') {
                    return confidence >= 0.7 && hasLecture;
                }
                if (filter === 'low') {
                    return confidence < 0.7 && confidence > 0 && hasLecture;
                }
                if (filter === 'nomatch') {
                    return !hasLecture;
                }
                return true;
            });
            currentIndex = 0;
            renderCard();
        }

        function showConfirmModal(title, message, buttonClass, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            const btn = document.getElementById('confirmModalBtn');
            btn.className = 'confirm-modal-btn ' + buttonClass;
            pendingAction = onConfirm;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            pendingAction = null;
            pendingIds = [];
        }

        async function executeConfirmedAction() {
            const action = pendingAction;
            const ids = [...pendingIds];
            closeConfirmModal();
            if (action) {
                await action(ids);
            }
        }

        function showToast(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function applyHighConfidence() {
            const highConfidenceIds = allItems
                .filter(item => (item.confidence || 0) >= CONFIDENCE_THRESHOLD && item.lecture_id)
                .map(item => item.question_id);

            if (highConfidenceIds.length === 0) {
                showToast('\uC801\uC6A9\uD560 \uD655\uC2E4\uD55C \uC81C\uC548\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.');
                return;
            }

            pendingIds = highConfidenceIds;
            showConfirmModal(
                '\uD655\uC2E4\uD55C \uC81C\uC548 \uC801\uC6A9',
                `${highConfidenceIds.length}\uAC1C\uC758 \uD655\uC2E4\uD55C \uC81C\uC548\uC744 \uC801\uC6A9\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?`,
                'confirm-modal-btn-success',
                applyClassification
            );
        }

        async function applySelected() {
            if (selectedIds.size === 0) {
                showToast('\uC120\uD0DD\uB41C \uD56D\uBAA9\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.');
                return;
            }

            pendingIds = Array.from(selectedIds);
            showConfirmModal(
                '\uC120\uD0DD \uD56D\uBAA9 \uC801\uC6A9',
                `${selectedIds.size}\uAC1C \uD56D\uBAA9\uC744 \uC801\uC6A9\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?`,
                'confirm-modal-btn-primary',
                applyClassification
            );
        }

        async function applyClassification(questionIds) {
            document.getElementById('loadingOverlay').classList.remove('hidden');

            try {
                const response = await fetch('/ai/classify/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: JOB_ID,
                        question_ids: questionIds
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const isSingleApply = questionIds.length === 1;
                    if (isSingleApply) {
                        showToast(`${data.applied_count}Í∞ú Î¨∏Ï†úÍ∞Ä Î∂ÑÎ•òÎêòÏóàÏäµÎãàÎã§.`, 'success');
                        const appliedId = questionIds[0];
                        allItems = allItems.filter(item => item.question_id !== appliedId);
                        filteredItems = filteredItems.filter(item => item.question_id !== appliedId);
                        selectedIds.delete(appliedId);
                        if (currentIndex >= filteredItems.length) {
                            currentIndex = Math.max(0, filteredItems.length - 1);
                        }
                        updateSelectedCount();
                        renderCard();
                        if (filteredItems.length === 0) {
                            showToast('Î™®Îì† Î¨∏Ï†úÍ∞Ä Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
                        }
                    } else {
                        alert(`${data.applied_count}Í∞ú Î¨∏Ï†úÍ∞Ä Î∂ÑÎ•òÎêòÏóàÏäµÎãàÎã§.`);
                        window.location.href = '{{ url_for("exam.unclassified_questions") }}';
                    }
                } else {
                    alert('Ï†ÅÏö© Ïã§Ìå®: ' + data.error);
                }
            } catch (error) {
                alert('Ïò§Î•ò Î∞úÏÉù: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        function showError(message) {
            document.getElementById('emptyState').innerHTML = `
                <div class="icon">‚ùå</div>
                <p>${message}</p>
                <a href="{{ url_for('exam.unclassified_questions') }}" style="color: #667eea; margin-top: 1rem; display: inline-block;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</a>
            `;
        }

        // Ï¥àÍ∏∞ ÏÑ†ÌÉù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        setTimeout(() => {
            document.querySelectorAll('.question-checkbox:checked').forEach(cb => {
                selectedIds.add(parseInt(cb.dataset.id));
            });
            updateSelectedCount();
        }, 100);
    </script>
</body>

</html>
