# 리팩토링 가이드 (상세)

이 문서는 Exam Manager의 유지보수성과 확장성을 높이기 위한 리팩토링 가이드입니다. 기능을 깨지 않고 구조를 개선하는 것을 최우선으로 합니다.

## 목표
- 라우트/서비스/데이터 접근 경계를 명확히 분리
- PDF/AI 파이프라인 안정화 및 재사용성 강화
- API 계약과 프론트 타입 일치
- 변경 범위를 작게 유지하면서 점진적으로 품질 개선

## 기본 원칙
- 기존 동작과 API 스키마는 유지 (기능 변경 금지)
- DB 스키마 변경 시 마이그레이션 스크립트 동반
- 한 번에 한 영역만 리팩토링
- 변경 전후에 검증 가능한 최소 체크리스트 유지

## 시작 전 준비
1) 데이터 백업
- `data/exam.db`를 복사해 스냅샷 확보

2) 환경 고정
- `.env`와 `next_app/.env.local`의 현재 값 기록

3) 기준선 확보
- PDF 업로드 → 문제 생성
- 문제 분류 (수동/일괄)
- AI 분류 시작/상태/적용
- 연습 시작 → 제출 → 결과 확인

4) 범위 선언
- 이번 리팩토링에서 건드릴 파일 목록을 명시
- API/DB 변경 여부를 사전에 합의

## 코드 기반 리팩토링 포인트 (현 상태)
- 유틸리티 위치 혼재
  - `app/routes/parse_pdf_questions.py`, `app/routes/crop.py`는 라우트가 아닌 CLI 유틸리티 성격
- API 응답 형식 불일치
  - 일부 API는 `{ ok, code, message }`, 일부는 `{ status }` 형태
- 연습 세션 흐름 불일치
  - Next.js는 세션 생성 API가 없어 클라이언트 fallback 모드로 시작

## 최근 반영
- 마크다운 이미지 처리 및 시험 필터 파싱 공통화
  - `app/services/markdown_images.py`, `app/services/practice_filters.py`
- `pdf_parser_experimental`는 legacy parser 래퍼로 정리

## 단계별 리팩토링 전략

### 1) 공통 유틸/서비스 분리
목표: 중복 제거와 테스트 가능성 확보.

권장 작업 순서
1) 공통 로직 후보 선정 (예: 마크다운 이미지 처리, 시험 필터 파싱)
2) `app/services/` 또는 `app/utils/`에 모듈 생성
3) 라우트에서 유틸 호출로 교체
4) 기존 동작과 결과 비교 (샘플 데이터 기준)

예시 대상(이미 분리됨)
- 마크다운 이미지 처리: `app/routes/manage.py`, `app/routes/api_manage.py`
- 시험 필터 처리: `app/routes/practice.py`, `app/routes/api_practice.py`

### 2) PDF 파서 인터페이스 통일
목표: 파서 교체 비용을 낮추고 결과 포맷을 고정.

권장 작업 순서
1) `PdfParseResult` 구조 정의 (시험/문항/선지/이미지 메타)
2) `pdf_parser`와 `pdf_parser_experimental`을 동일 인터페이스로 래핑
3) `PDF_PARSER_MODE` 선택을 오케스트레이터로 이동
4) 동일 PDF로 결과 비교 테스트

### 3) 서비스 레이어 정비
목표: 라우트는 얇게, 서비스는 두껍게.

권장 작업 순서
1) 라우트에서 긴 로직을 서비스 함수로 분리
2) 서비스 함수는 입력/출력 명시 (dict/dataclass)
3) `current_app.config` 접근 최소화 (필요 값은 인자로 전달)

권장 대상
- `app/routes/manage.py`: PDF 업로드, 대량 처리 로직
- `app/routes/exam.py`: 분류/일괄 분류 로직
- `app/routes/ai.py`: AI 분류 배치 흐름

### 4) 데이터 접근 레이어 정리
목표: 쿼리 중복 제거 및 트랜잭션 일관성 확보.

권장 작업 순서
1) 자주 사용하는 쿼리를 함수로 분리
2) `db.session.commit()` 호출 위치 통일
3) 리스트 페이지에서 N+1 여부 확인

예시
- `get_exam_with_questions(exam_id)` 같은 헬퍼 추가
- `lecture`/`exam`/`question` 상세 로딩 로직 통합

### 5) API 계약 및 타입 동기화
목표: Flask API와 Next.js 타입 불일치 최소화.

권장 작업 순서
1) 응답 포맷을 통일 (`ok`, `code`, `message`, `data`)
2) Next.js의 타입 정의와 서버 응답 동기화
3) API 변경 시 문서/프론트/백엔드 동시 수정

### 6) 연습 세션 흐름 정합성
목표: Legacy/Next 연습 흐름 간 불일치 해소.

권장 작업 순서
1) `/api/practice/lecture/<id>/start` 같은 세션 시작 API 설계
2) Next.js가 서버 세션을 사용하도록 정리
3) 세션 저장 타이밍(시작/제출)을 명확히 문서화

### 7) 테스트/검증 체계 강화
목표: 리팩토링 안전장치 확보.

권장 작업 순서
1) 최소 체크리스트 유지 (수동 테스트 우선)
2) 무거운 기능(PDF 업로드/AI 분류)은 샘플 데이터로 점검
3) 변경 범위에 맞는 최소 단위 테스트만 추가

### 8) 정리 및 문서 갱신
목표: 리팩토링 결과를 문서에 반영.

권장 작업 순서
1) README 및 `docs/` 갱신
2) 불필요 파일/임시 코드 제거
3) 마이그레이션 스크립트 정리

## 작업 템플릿 (매 변경마다 반복)
1) 대상 범위 선정 (파일/함수)
2) 변경 전 동작 확인
3) 리팩토링 적용
4) 영향 범위 점검 (API/DB/프론트)
5) 최소 검증 수행
6) 문서 업데이트

## 중단 기준
- 기능 회귀가 확인되면 즉시 중단하고 원인 파악
- DB 마이그레이션 실패 시 롤백 후 재시도
- 변경 범위가 커질 경우 작업을 분할

## 참고 문서
- 운영/스크립트: `docs/operations/scripts.md`
- 환경변수: `docs/setup/env.md`
